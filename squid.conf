#
# SQUID PROXY - WHITELIST CONFIGURATION
# Generated by setup_squid_whitelist.py
# Whitelisted domain: .google.com
# Listen port: 8080
# SSL Bump: noverify
#

# ACL definitions
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# Whitelist domain ACL
acl whitelist_domain dstdomain .google.com

# Security rules - deny unsafe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost manager
http_access deny manager

# Allow whitelisted domain only (HTTP and HTTPS)
http_access allow whitelist_domain

# Deny everything else
http_access deny all

# ------------------------------------------------------------------------------
# SSL BUMP CONFIGURATION
# Mode: noverify
# ------------------------------------------------------------------------------

# SSL Bump listening port
http_port 8080 ssl-bump \
    cert=/etc/squid/certs/squid-ca-cert.pem \
    key=/etc/squid/certs/squid-ca-key.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=4MB

# SSL certificate database
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 5

# SSL Bump ACLs
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# Peek at SNI in step 1
ssl_bump peek step1

# Splice whitelisted domains, terminate others
ssl_bump splice whitelist_domain
ssl_bump terminate all

# Certificate validation: DISABLED
# All certificates will be accepted (insecure)
sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Cache directory
cache_dir ufs /var/spool/squid 100 16 256

# Refresh patterns
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# PID file
pid_filename /var/run/squid.pid

# Visible hostname
visible_hostname squid-whitelist-proxy
